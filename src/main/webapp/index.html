<!DOCTYPE html>
<html>
<head>
<title>Simple Map</title>
<meta name="viewport" content="initial-scale=1.0">
<meta charset="utf-8">
<style>
/* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
#map {
	height: 100%;
	width: 70%;
}

#hContainer {
	height: 100%;
	width: 100%;
	display: flex;
	flex-direction: row;
	align-items: flex-start;
}

#vContainer {
	display: flex;
	flex-direction: column;
	align-items: flex-start;
}
/* Optional: Makes the sample page fill the window. */
html, body {
	height: 100%;
	margin: 0;
	padding: 0;
}
</style>
</head>
<body>
	<div id="hContainer">
		<div id="map"></div>
		<div id="vContainer">
			<div id="hContainer">
				<input id="inptLat"> <input id="inptLon">
			</div>
			<div style="background-color: red; width: 100%; height: 10px;"></div>

			<input id="title" style="width: 100%;" value="Land">
			<textarea id="description" style="width: 100%;" placeholder="Description of the ad"></textarea>
			<input id="price" style="width: 100%;" value="1000"> <input id="ownerName" style="width: 100%;" value="Ihor">
			<input id="ownerPhone" type="tel" style="width: 100%;" value="+380630000000"> <input id="ownerEmail"
				type="email" style="width: 100%;" value="alool@gmail.com"> <input id="plotCadNum" style="width: 100%;"
				value="4623610100:02:001:0264"> <input id="addPlotBtn" type="button" value="Add Plot" style="width: 100%;">
		</div>
	</div>
	<script>
		var map, infoWindow;
		var markers = [];
		document.getElementById("addPlotBtn").onclick = addPlot;

		function addPlot() {
			var title = document.getElementById('title');
			var description = document.getElementById('description');
			var price = document.getElementById('price');
			var ownerName = document.getElementById('ownerName');
			var ownerPhone = document.getElementById('ownerPhone');
			var ownerEmail = document.getElementById('ownerEmail');
			var plotCadNum = document.getElementById('plotCadNum');
			$.ajax({
				type : "POST",
				url : window.location.pathname + 'rest/announcement/add',
				data : JSON.stringify({
					title : title.value,
					description : description.placeholder,
					price : price.value,
					owner : {
						name : ownerName.value,
						phone : ownerPhone.value,
						email : ownerEmail.value
					},
					plots : [ {
						cadNum : plotCadNum.value
					} ]
				}),
				contentType : "application/json; charset=utf-8",
				dataType : "json",
				success : function(data) {
					addMapMarker(data);
				}
			});
		}

		function initMap() {
			map = new google.maps.Map(document.getElementById('map'), {
				center : {
					lat : 49.811,
					lng : 23.992
				},
				zoom : 15
			});

			// Try HTML5 geolocation.
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(function(position) {
					var pos = {
						lat : position.coords.latitude,
						lng : position.coords.longitude
					};

					map.setCenter(pos);

					map.addListener('click', function(e) {
						var inptLat = document.getElementById('inptLat')
						var inptLon = document.getElementById('inptLon')
						inptLat.value = e.latLng.lat()
						inptLon.value = e.latLng.lng()
					});
					map.addListener('idle', searchLocations);

				}, function() {
					handleLocationError(true, infoWindow, map.getCenter());
				});
			} else {
				// Browser doesn't support Geolocation
				handleLocationError(false, infoWindow, map.getCenter());
			}
		}

		function searchLocations(e) {
			clearMarkers();
			var bounds = map.getBounds();
			var NECorner = bounds.getNorthEast();
			var SWCorner = bounds.getSouthWest();
			var NWCorner = new google.maps.LatLng(NECorner.lat(), SWCorner.lng());
			var SECorner = new google.maps.LatLng(SWCorner.lat(), NECorner.lng());
			//var polygon = new google.maps.Polygon({
			//map : map,
			//paths : [ NWCorner, NECorner, SECorner, SWCorner ],
			//fillColor : 'red',
			//fillOpacity : 0.7
			//});
			$.ajax({
				type : "POST",
				url : window.location.pathname + 'rest/announcement/list',
				contentType : "application/json; charset=utf-8",
				dataType : "json",
				data : JSON.stringify({
					neCorner : NECorner,
					swCorner : SWCorner,
					nwCorner : NWCorner,
					seCorner : SECorner
				}),
				success : function(data) {
					for (var i = 0; i < data.length; i++) {
						addMapMarker(data[i]);
					}
				}
			});
		}

		function addMapMarker(announcement) {
			console.log(announcement.price);
			for (var j = 0; j < announcement.plots.length; j++) {
				var plot = announcement.plots[j];
				var pos = {
					lat : plot.lat,
					lng : plot.lng
				};
				console.log(announcement.price);
				var marker = new google.maps.Marker({
					position : pos,
					map : map,
					title : announcement.price.toString(10)
				});
				markers.push(marker);
			}
		}

		function setMapOnAll(map) {
			for (var i = 0; i < markers.length; i++) {
				markers[i].setMap(map);
			}
		}

		// Removes the markers from the map, but keeps them in the array.
		function clearMarkers() {
			setMapOnAll(null);
		}

		function handleLocationError(browserHasGeolocation, infoWindow, pos) {
			infoWindow.setPosition(pos);
			infoWindow.setContent(browserHasGeolocation ? 'Error: The Geolocation service failed.'
					: 'Error: Your browser doesn\'t support geolocation.');
			infoWindow.open(map);
		}
	</script>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCc75wY-xCuCV5O3XTr0dRkzghpDuU72C4&callback=initMap"
		async defer></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</body>
</html>