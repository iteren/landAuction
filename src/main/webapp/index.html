<!DOCTYPE html>
<html>
<head>
<title>Simple Map</title>
<meta name="viewport" content="initial-scale=1.0">
<meta charset="utf-8">
<style>
/* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
#map {
	height: 100%;
	width: 70%;
}

#container {
	height: 100%;
	width: 100%;
	display: flex;
	flex-direction: row;
	align-items: flex-start;
}
/* Optional: Makes the sample page fill the window. */
html, body {
	height: 100%;
	margin: 0;
	padding: 0;
}
</style>
</head>
<body>
	<div id="container">
		<div id="map"></div>
		<div id="inputs">
			<input id="inptLat"> <input id="inptLon"> <input id="addLocBtn" type="button" value="Add Location">
		</div>
		<div id="inputs2">
			<input id="cadNumInput"> <input id="addPlotBtn" type="button" value="Add Plot">
		</div>
	</div>
	<script>
		var map, infoWindow;
		var markers = [];
		document.getElementById("addLocBtn").onclick = submitLocation;
		document.getElementById("addPlotBtn").onclick = addPlot;

		function submitLocation() {
			var inptLat = document.getElementById('inptLat')
			var inptLon = document.getElementById('inptLon')
			$.ajax({
				type : "POST",
				url : window.location.pathname + 'rest/addLocation',
				data : JSON.stringify({
					lat : inptLat.value,
					lng : inptLon.value
				}),
				contentType : "application/json; charset=utf-8",
				dataType : "json"
			});
		}

		function addPlot() {
			var cadNumInput = document.getElementById('cadNumInput')
			$.ajax({
				type : "GET",
				url : window.location.pathname + 'rest/addPlot',
				data : {
					cadNum : cadNumInput.value
				},
				contentType : "application/json; charset=utf-8",
				dataType : "json",
				success : function(data) {
					console.log(data.lat);
					console.log(data.lng);
					var pos = {
						lat : data.lat,
						lng : data.lng
					};
					var marker = new google.maps.Marker({
						position : pos,
						map : map
					});
					markers.push(marker);
				}
			});
		}

		function initMap() {
			map = new google.maps.Map(document.getElementById('map'), {
				center : {
					lat : 49.811,
					lng : 23.992
				},
				zoom : 15
			});

			// Try HTML5 geolocation.
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(function(position) {
					var pos = {
						lat : position.coords.latitude,
						lng : position.coords.longitude
					};

					map.setCenter(pos);

					map.addListener('click', function(e) {
						var inptLat = document.getElementById('inptLat')
						var inptLon = document.getElementById('inptLon')
						inptLat.value = e.latLng.lat()
						inptLon.value = e.latLng.lng()
					});
					map.addListener('idle', searchLocations);
					//map.addListener('dragend', searchLocations);

				}, function() {
					handleLocationError(true, infoWindow, map.getCenter());
				});
			} else {
				// Browser doesn't support Geolocation
				handleLocationError(false, infoWindow, map.getCenter());
			}
		}

		function searchLocations(e) {
			clearMarkers();
			var bounds = map.getBounds();
			var NECorner = bounds.getNorthEast();
			var SWCorner = bounds.getSouthWest();
			var NWCorner = new google.maps.LatLng(NECorner.lat(), SWCorner.lng());
			var SECorner = new google.maps.LatLng(SWCorner.lat(), NECorner.lng());
			//var polygon = new google.maps.Polygon({
			//map : map,
			//paths : [ NWCorner, NECorner, SECorner, SWCorner ],
			//fillColor : 'red',
			//fillOpacity : 0.7
			//});
			$.ajax({
				type : "POST",
				url : window.location.pathname + 'rest/getLocations',
				contentType : "application/json; charset=utf-8",
				dataType : "json",
				data : JSON.stringify({
					neCorner : NECorner,
					swCorner : SWCorner,
					nwCorner : NWCorner,
					seCorner : SECorner
				}),
				success : function(data) {
					for (var i = 0; i < data.length; i++) {
						var obj = data[i];
						console.log(obj.id);
						console.log(obj.lat);
						console.log(obj.lng);
						var pos = {
							lat : obj.lat,
							lng : obj.lng
						};
						var marker = new google.maps.Marker({
							position : pos,
							map : map
						//title : 'Price:23 000$'
						});
						markers.push(marker);
					}
				}
			});
		}

		function setMapOnAll(map) {
			for (var i = 0; i < markers.length; i++) {
				markers[i].setMap(map);
			}
		}

		// Removes the markers from the map, but keeps them in the array.
		function clearMarkers() {
			setMapOnAll(null);
		}

		function handleLocationError(browserHasGeolocation, infoWindow, pos) {
			infoWindow.setPosition(pos);
			infoWindow.setContent(browserHasGeolocation ? 'Error: The Geolocation service failed.'
					: 'Error: Your browser doesn\'t support geolocation.');
			infoWindow.open(map);
		}
	</script>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCc75wY-xCuCV5O3XTr0dRkzghpDuU72C4&callback=initMap"
		async defer></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</body>
</html>